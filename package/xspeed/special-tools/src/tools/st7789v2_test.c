#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/select.h>
#include <sys/time.h>
#include <errno.h>
#include <linux/i2c.h>
#include <linux/i2c-dev.h>
#include <sys/ioctl.h>

#include <stdio.h>
#include <stdint.h>

#define W 320
#define H 240

int fd;
unsigned char PIC[H * W * 2];
unsigned short color;

// 字符串的网址参考 https://www.zhetao.com/fontarray.html
static uint8_t bitmap_bytes[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x1c, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xff, 0x00, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x3f, 0xff, 0x80, 0x00, 0x1f, 0x80, 0x0f, 0x80, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00,
    0x00, 0x00, 0x1f, 0xff, 0xff, 0xc0, 0x00, 0x3f, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x3f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x30, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x01, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x03, 0xc0, 0xe0, 0x00, 0x70, 0x01, 0xf0, 0x0f, 0x00, 0x00, 0x00, 0x78, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x00, 0x78, 0x00, 0x03, 0xc1, 0xf0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0x80, 0x1f, 0xff, 0xfc, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x00, 0x0f, 0xe0, 0x00, 0x00, 0x00, 0xf8, 0x3f, 0xff, 0xff, 0xf8, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xc0, 0x1f, 0xff, 0xfe, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x00, 0x1f, 0x80, 0x00, 0x00, 0x00, 0xf0, 0x3f, 0xff, 0xff, 0xfc, 0x00, 0x7c, 0x00, 0x00, 0x0f, 0x80, 0x0f, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x01, 0x80,
    0x00, 0x00, 0x3f, 0x00, 0x30, 0x00, 0x01, 0xe0, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x03, 0x00, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x00, 0x7c, 0x00, 0x78, 0x00, 0x01, 0xe0, 0xf0, 0x0f, 0x80, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0xe0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xe0,
    0x00, 0x00, 0xf8, 0x00, 0xfc, 0x00, 0x03, 0xc1, 0xf8, 0x1f, 0xc0, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x03, 0xff, 0xff, 0xff, 0xff, 0xe0,
    0x00, 0x03, 0xf0, 0x03, 0xfe, 0x00, 0x07, 0x81, 0xf8, 0x1f, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x0f, 0xc0, 0x07, 0xf0, 0x00, 0x0f, 0x83, 0xf0, 0x3e, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x06, 0xe3, 0xc0, 0xf8, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x3f, 0xff, 0xff, 0xc0, 0x00, 0x1f, 0x1f, 0xe0, 0x7c, 0x78, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x0f, 0x03, 0xc0, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x3f, 0xff, 0xff, 0x00, 0x00, 0x3f, 0xff, 0xc0, 0xf8, 0x3e, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0x00, 0x7f, 0xff, 0xff, 0x87, 0x80, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x3f, 0xf8, 0xfe, 0x00, 0x00, 0x1f, 0xff, 0x80, 0xf0, 0x1f, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0x00, 0x3f, 0xff, 0xff, 0xc7, 0x80, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x1f, 0x03, 0xf8, 0x00, 0x00, 0x1f, 0x1f, 0x01, 0xe0, 0x0f, 0xc0, 0x00, 0x3c, 0x00, 0x00, 0x0f, 0x00, 0x1c, 0x1e, 0x00, 0x07, 0x80, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x18, 0x07, 0xe1, 0x80, 0x00, 0x0c, 0x1e, 0x03, 0xc0, 0x07, 0xe0, 0x00, 0x3c, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x3f, 0x00, 0x07, 0x80, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x00, 0x1f, 0x81, 0xf0, 0x00, 0x00, 0x3c, 0x0f, 0x80, 0x3f, 0xf0, 0x00, 0x7c, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x3f, 0x00, 0x07, 0x80, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x00, 0x7f, 0x00, 0xfc, 0x00, 0x00, 0x7c, 0x1f, 0xff, 0xff, 0xf0, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x07, 0x80, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x01, 0xfc, 0x00, 0x7f, 0x00, 0x00, 0xf8, 0x0f, 0xff, 0xf9, 0xf0, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x07, 0x80, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x07, 0xf0, 0x00, 0x3f, 0xc0, 0x01, 0xf0, 0x0f, 0xfc, 0x78, 0xf0, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x00, 0x07, 0x80, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x3f, 0xc0, 0x1f, 0xff, 0xc0, 0x03, 0xe0, 0x07, 0x7c, 0x78, 0x70, 0x00, 0x79, 0xc0, 0x00, 0x0e, 0x00, 0x00, 0xf9, 0xc0, 0x07, 0x80, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x07, 0xc0, 0xf8, 0x7c, 0x78, 0x00, 0x00, 0x79, 0xff, 0xff, 0xff, 0x00, 0x00, 0xf0, 0xe0, 0x0f, 0x00, 0xf0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xc0,
    0x00, 0xff, 0xff, 0xf0, 0x07, 0xe0, 0x1f, 0xff, 0xf8, 0x7c, 0x78, 0x00, 0x00, 0x79, 0xff, 0xff, 0xff, 0x80, 0x01, 0xe0, 0xf0, 0x0f, 0x00, 0xf0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xc0,
    0x00, 0x7f, 0xe0, 0xf0, 0x03, 0xe0, 0x1f, 0xff, 0x80, 0x7c, 0x78, 0x00, 0x00, 0x78, 0xf0, 0x00, 0x0f, 0x80, 0x03, 0xe0, 0x78, 0x0f, 0x00, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x3c, 0x00, 0xf0, 0x01, 0xe0, 0x0f, 0xf8, 0x00, 0x7c, 0x78, 0x00, 0x00, 0x78, 0xf0, 0x00, 0x0f, 0x00, 0x03, 0xc0, 0x7c, 0x1f, 0x01, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x00, 0x00, 0xf0, 0x01, 0xc0, 0x0f, 0xc0, 0x00, 0x78, 0x78, 0x00, 0x00, 0xf8, 0xf0, 0x00, 0x0f, 0x00, 0x07, 0x80, 0x3e, 0x1e, 0x01, 0xf0, 0x03, 0xc0, 0x07, 0xc0, 0x03, 0xc0,
    0x00, 0x01, 0xe0, 0xf6, 0x00, 0x00, 0x07, 0x00, 0x00, 0x78, 0x78, 0x00, 0x00, 0xf8, 0xf0, 0x00, 0x0f, 0x00, 0x07, 0x00, 0x3f, 0x1e, 0x01, 0xf0, 0x03, 0x00, 0x07, 0xc0, 0x03, 0x00,
    0x00, 0x01, 0xf0, 0xf7, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x78, 0x78, 0x00, 0x00, 0xf0, 0xf0, 0x00, 0x0f, 0x00, 0x0f, 0x00, 0xff, 0x3e, 0x01, 0xe0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x03, 0xf8, 0xf3, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x78, 0x78, 0x00, 0x00, 0xf0, 0xf0, 0x00, 0x0f, 0x00, 0x1f, 0xff, 0xff, 0x3c, 0x01, 0xe0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x07, 0xf8, 0xf0, 0xfc, 0x00, 0x00, 0x00, 0xf8, 0xf8, 0x78, 0x00, 0x01, 0xf0, 0xf0, 0x00, 0x0f, 0x00, 0x3f, 0xff, 0x8f, 0x7c, 0x01, 0xe0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x0f, 0xc0, 0xf0, 0x7f, 0x80, 0x00, 0x0f, 0xf8, 0xf8, 0x78, 0x30, 0x01, 0xe0, 0xf0, 0x00, 0x0f, 0x00, 0x3f, 0xf8, 0x0f, 0x78, 0x01, 0xe0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x1f, 0x80, 0xf0, 0x3f, 0xc0, 0x00, 0xff, 0xc0, 0xf0, 0x78, 0x30, 0x01, 0xe0, 0xf0, 0x00, 0x0f, 0x00, 0x1f, 0x80, 0x0f, 0xf0, 0x01, 0xe0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x3e, 0x00, 0xf0, 0x0f, 0xe0, 0x3f, 0xfe, 0x01, 0xf0, 0x78, 0x38, 0x03, 0xc0, 0xf0, 0x00, 0x0f, 0x00, 0x1e, 0x00, 0x07, 0xf0, 0x01, 0xe0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0xfc, 0x00, 0xf0, 0x07, 0xf0, 0x1f, 0xf0, 0x01, 0xe0, 0x78, 0x38, 0x03, 0xc0, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x01, 0xe0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x01, 0xf0, 0x01, 0xf0, 0x03, 0xf0, 0x1f, 0xc0, 0x03, 0xe0, 0x78, 0x38, 0x07, 0x80, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x03, 0xe0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x07, 0xe0, 0xff, 0xf0, 0x01, 0xf0, 0x1f, 0x00, 0x07, 0xc0, 0x78, 0x38, 0x07, 0x00, 0xf0, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x07, 0x83, 0xf7, 0xe0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x0f, 0x80, 0x7f, 0xf0, 0x01, 0xf0, 0x0e, 0x00, 0x0f, 0x80, 0x78, 0x7c, 0x0f, 0x01, 0xf0, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x0f, 0x03, 0xff, 0xc0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x3e, 0x00, 0x0f, 0xe0, 0x00, 0xf0, 0x00, 0x00, 0x3f, 0x00, 0x7f, 0xfc, 0x1e, 0x01, 0xf0, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x1e, 0x00, 0xff, 0xc0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x38, 0x00, 0x07, 0xe0, 0x00, 0x60, 0x00, 0x00, 0x7c, 0x00, 0x7f, 0xfc, 0x3c, 0x01, 0xf0, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x3f, 0xf8, 0x38, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

static uint16_t RGB565(uint8_t red, uint8_t green, uint8_t blue)
{
    uint16_t color = 0;
    color |= (red >> 3) << 11;  // 将red的高5位放到color的高5位
    color |= (green >> 2) << 5; // 将green的高6位放到color的中间6位
    color |= blue >> 3;         // 将blue的高5位放到color的低5位
    return color;
}

/* 自定义图片 */
static void HT7789V2_INIT_TEXT_SHOW()
{
    uint16_t x_max = 0x0140;
    uint16_t y_max = 0x00F0;
    uint16_t i, j;
    uint8_t bitmap_x = 30;    // bitmap_bytes 横列数量
    uint8_t bitmap_size = 48; // bitmap_bytes 竖列数量 也是 字符的大小
    uint8_t y_bitmap_count = (y_max - bitmap_size) / 2;
    uint8_t x_bitmap_count = (x_max - bitmap_x * 8) / 2;
    uint16_t color_black = RGB565(0x00, 0x00, 0x00);
    uint16_t color_white = RGB565(0xFF, 0xFF, 0xFF);

    for (i = 0; i < x_max; i++)
    {
        for (j = 0; j < y_max; j++)
        {
            if (((i >= x_bitmap_count) && (i < x_bitmap_count + (bitmap_x * 8))) && (j >= y_bitmap_count && j < y_bitmap_count + bitmap_size) && (bitmap_bytes[((bitmap_size - 1 - ((j - y_bitmap_count) % bitmap_size)) * bitmap_x) + ((i - x_bitmap_count) / 8)] & (1 << (7 - ((i - x_bitmap_count) % 8)))))
            {
                PIC[2 * (i * H + j)] = color_black >> 8;
                PIC[2 * (i * H + j) + 1] = color_black & 0xff;
            }
            else
            {
                PIC[2 * (i * H + j)] = color_white >> 8;
                PIC[2 * (i * H + j) + 1] = color_white & 0xff;
            }
        }
    }
}

/* 清屏 */
void Clear(uint16_t color)
{
    for (int i = 0; i < H * W; ++i)
    {
        PIC[2 * i] = color >> 8;
        PIC[2 * i + 1] = color & 0xff;
    }
}

/* 画一个方形 */
void Draw_rect(uint16_t x1, uint16_t y1, uint16_t x2, uint16_t y2, uint8_t fill, uint16_t color)
{
    for (int i = x1; i <= x2; ++i)
    {
        for (int j = y1; j <= y2; ++j)
        {
            PIC[2 * (i * H + j)] = color >> 8;
            PIC[2 * (i * H + j) + 1] = color & 0xff;
        }
    }
}

/* 主函数  */
int main(int argc, char *argv[])
{
    int aaa = 0, ret = 0;

    fd = open("/dev/dev_st7789v2", O_RDWR); // open file and enable read and  write
    if (fd < 0)
    {
        perror("Can't open /dev/dev_st7789v2 \n"); // open i2c dev file fail
        exit(1);
    }

    printf("\r\nplease input a hex color: ");
    if (scanf("%hx", &color) != 1)
    {
        fprintf(stderr, "Invalid input for color.\n");
        return -1;
    }
    printf("new this color is %x\r\n", color);

    printf("\r\nplease input function: ");
    if (scanf("%d", &aaa) != 1)
    {
        fprintf(stderr, "Invalid input for color.\n");
        return -1;
    }

    /* 0:清屏 1:方框 2:自定义图片*/
    if (aaa == 0)
    {
        Clear(color);
        ret = write(fd, PIC, W * H * 2);
    }
    else if (aaa == 1)
    {
        Draw_rect(0, 0, W / 2, H / 2, 0, ~color);
        ret = write(fd, PIC, W * H * 2);
    }
    else if (aaa == 2)
    {
        HT7789V2_INIT_TEXT_SHOW();
        ret = write(fd, PIC, W * H * 2);
    }

    if (ret == -1)
        perror("Write error");

    close(fd);
}